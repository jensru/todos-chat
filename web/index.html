<!DOCTYPE html>
<html lang="de" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat + Canvas Todo App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Shadcn CSS Variables -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body class="h-full bg-background text-foreground">
    <div id="root" class="h-full">
        <!-- React App wird hier gerendert -->
    </div>
    
    <!-- Services -->
    <script src="js/services/TaskService.js"></script>
    <script src="js/services/DragDropService.js"></script>
    
    <!-- React Components -->
    <script type="text/babel" src="js/components/ChatPanel.js"></script>
    <script type="text/babel" src="js/components/CanvasPanel.js"></script>
    <script type="text/babel" src="js/components/TaskCard.js"></script>
    <script type="text/babel" src="js/components/GoalCard.js"></script>
    <script type="text/babel" src="js/components/EmptyState.js"></script>
    
    <!-- Main React App -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error('Error Boundary caught an error:', error, errorInfo);
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex h-full items-center justify-center bg-background">
                            <div className="text-center p-8">
                                <div className="text-destructive text-2xl mb-4">⚠️</div>
                                <h2 className="text-xl font-semibold text-foreground mb-2">
                                    Etwas ist schiefgelaufen
                                </h2>
                                <p className="text-muted-foreground mb-4">
                                    Die App konnte nicht geladen werden. Bitte lade die Seite neu.
                                </p>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="btn-primary px-4 py-2"
                                >
                                    Seite neu laden
                                </button>
                                <details className="mt-4 text-left">
                                    <summary className="cursor-pointer text-sm text-muted-foreground">
                                        Technische Details
                                    </summary>
                                    <pre className="text-xs text-muted-foreground mt-2 p-2 bg-muted rounded">
                                        {this.state.error?.toString()}
                                    </pre>
                                </details>
                            </div>
                        </div>
                    );
                }
                
                return this.props.children;
            }
        }
        
        function App() {
            const [theme, setTheme] = useState('light');
            const [tasks, setTasks] = useState([]);
            const [goals, setGoals] = useState([]);
            const [messages, setMessages] = useState([
                { id: 1, type: 'bot', text: 'Hey, woran willst du heute arbeiten?', timestamp: new Date() }
            ]);
            const [workingStyleDNA, setWorkingStyleDNA] = useState({});
            const [taskService, setTaskService] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                // Load theme from localStorage
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                // Initialize TaskService and load tasks
                const service = new TaskService();
                setTaskService(service);
                
                // Load tasks from database
                service.loadTasks().then(() => {
                    try {
                        const dbTasks = service.getReactTasks();
                        setTasks(dbTasks);
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                        setTasks([]);
                    } finally {
                        setLoading(false);
                    }
                }).catch(error => {
                    console.error('Error initializing TaskService:', error);
                    setTasks([]);
                    setLoading(false);
                });
                
                // Load data from localStorage
                const savedData = localStorage.getItem('todo-app-data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    setGoals(data.goals || []);
                    setWorkingStyleDNA(data.workingStyleDNA || {});
                }
            }, []);
            
            useEffect(() => {
                // Save data to localStorage whenever it changes
                const data = { tasks, goals, workingStyleDNA };
                localStorage.setItem('todo-app-data', JSON.stringify(data));
            }, [tasks, goals, workingStyleDNA]);
            
            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            };
            
            const addMessage = (message) => {
                setMessages(prev => [...prev, { 
                    id: Date.now(), 
                    type: message.type, 
                    text: message.text, 
                    timestamp: new Date() 
                }]);
            };
            
            const addTask = (task) => {
                setTasks(prev => [...prev, { 
                    id: Date.now(), 
                    ...task, 
                    createdAt: new Date() 
                }]);
            };
            
            const addGoal = (goal) => {
                setGoals(prev => [...prev, { 
                    id: Date.now(), 
                    ...goal, 
                    createdAt: new Date() 
                }]);
            };
            
            if (loading) {
                return (
                    <div className="chat-canvas-container flex h-full items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p className="text-muted-foreground">Lade deine Aufgaben...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="chat-canvas-container flex h-full">
                    <ChatPanel 
                        messages={messages}
                        onAddMessage={addMessage}
                        onAddTask={addTask}
                        onAddGoal={addGoal}
                        theme={theme}
                        onToggleTheme={toggleTheme}
                    />
                    <CanvasPanel 
                        tasks={tasks}
                        goals={goals}
                        workingStyleDNA={workingStyleDNA}
                        onUpdateTasks={setTasks}
                        onUpdateGoals={setGoals}
                        onUpdateDNA={setWorkingStyleDNA}
                        taskService={taskService}
                    />
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>