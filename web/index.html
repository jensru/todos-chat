<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Task Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="ui-guidelines.js"></script>
    <script src="date-sync.js"></script>
    <style>
        /* Import Google Sans */
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&display=swap');
        
        /* CSS Custom Properties - UI Guidelines */
        :root {
            /* Primary Colors */
            --primary: #0B57D0;
            --primary-hover: #0a4bb8;
            --primary-light: #e8f0fe;
            
            /* Secondary Colors */
            --secondary: #5f6368;
            --secondary-hover: #3c4043;
            --secondary-light: #f1f3f4;
            
            /* Highlight Color - Only Red */
            --highlight: #d93025;
            --highlight-hover: #b52d20;
            --highlight-light: #ffebee;
            
            /* Text Colors */
            --text-primary: #1f1f1f;
            --text-secondary: #444746;
            --text-tertiary: #747775;
            --text-disabled: #9aa0a6;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e8f0fe;
            
            /* Border Colors */
            --border-light: #e8eaed;
            --border-medium: #dadce0;
            --border-dark: #bdc1c6;
            
            /* Spacing System (8px Grid) */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        /* Smart Task Dashboard - Left Side */
        .smart-dashboard {
            flex: 1;
            padding: var(--space-6);
            background: var(--bg-primary);
            overflow-y: auto;
        }
        
        .header {
            margin-bottom: var(--space-6);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .header-left h1 {
            color: var(--primary);
            font-size: 32px;
            font-weight: 600;
            margin: 0 0 var(--space-2) 0;
        }
        
        .header-left p {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0;
        }
        
        .header-right {
            text-align: right;
        }
        
        .current-date {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }
        
        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--border-medium);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: var(--secondary-light);
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .stat-item {
            background: var(--bg-primary);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--space-1);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Task Cards */
        .smart-task-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            min-height: 50px;
            max-height: 50px;
        }
        
        .smart-task-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .task-meta {
            display: flex;
            gap: var(--space-2);
            align-items: center;
            flex-shrink: 0;
        }
        
        .priority-badge {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-high {
            background: var(--highlight-light);
            color: var(--highlight);
        }
        
        .priority-medium {
            background: var(--secondary-light);
            color: var(--secondary);
        }
        
        .priority-low {
            background: var(--secondary-light);
            color: var(--text-tertiary);
        }
        
        .deadline-badge {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .deadline-overdue {
            background: var(--highlight-light);
            color: var(--highlight);
        }
        
        .deadline-due-today {
            background: var(--highlight-light);
            color: var(--highlight);
        }
        
        .deadline-due-tomorrow {
            background: var(--secondary-light);
            color: var(--secondary);
        }
        
        .deadline-due-soon {
            background: var(--secondary-light);
            color: var(--secondary);
        }
        
        .task-tags {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .task-tag {
            background: var(--primary-light);
            color: var(--primary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
        }
        
        .due-date-display {
            margin-top: var(--space-1);
            padding: var(--space-1) var(--space-2);
            background: var(--secondary-light);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            border-left: 2px solid var(--primary);
            white-space: nowrap;
        }
        
        .task-stats {
            display: flex;
            gap: var(--space-2);
            align-items: center;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        /* Mistral Interface - Right Side */
        .mistral-sidebar {
            width: 400px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .mistral-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-light);
            background: var(--primary-light);
        }
        
        .mistral-header h2 {
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 var(--space-2) 0;
        }
        
        .mistral-header p {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0;
        }
        
        .mistral-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-4);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: var(--space-4);
            padding: var(--space-2);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }
        
        .message {
            margin-bottom: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            max-width: 80%;
        }
        
        .message.user {
            background: var(--primary-light);
            margin-left: auto;
            border: 1px solid var(--primary);
        }
        
        .message.assistant {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.4;
            margin: 0;
        }
        
        .message-time {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: var(--space-1);
        }
        
        .chat-input-container {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
            padding: var(--space-2);
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
        }
        
        .chat-input {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .send-btn {
            padding: var(--space-3) var(--space-4);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .send-btn:hover {
            background: var(--primary-hover);
        }
        
        .send-btn:disabled {
            background: var(--text-disabled);
            cursor: not-allowed;
        }
        
        /* Quick Actions */
        .quick-actions {
            margin-bottom: var(--space-4);
        }
        
        .quick-actions h3 {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 var(--space-2) 0;
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-2);
        }
        
        .quick-action-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--secondary-light);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        
        /* Loading */
        .loading {
            color: var(--text-tertiary);
            font-size: 14px;
            padding: var(--space-4);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .mistral-sidebar {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border-light);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Smart Task Dashboard - Left Side -->
        <div class="smart-dashboard">
            <div class="header">
                <div class="header-left">
                    <h1>üéØ Smart Task Dashboard</h1>
                    <p>Intelligente Task-Verwaltung mit AI-Unterst√ºtzung</p>
                </div>
                <div class="header-right">
                    <div class="current-date" id="currentDate">Lade Datum...</div>
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTasks('all')">Alle</button>
                <button class="filter-btn" onclick="filterTasks('heute')">Heute</button>
                <button class="filter-btn" onclick="filterTasks('woche')">Diese Woche</button>
                <button class="filter-btn" onclick="filterTasks('hoch')">Hochpriorit√§t</button>
                <button class="filter-btn" onclick="filterTasks('√ºberf√§llig')">√úberf√§llig</button>
            </div>
            
            <!-- Stats -->
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalTasks">-</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completedTasks">-</div>
                    <div class="stat-label">Erledigt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dueToday">-</div>
                    <div class="stat-label">Heute f√§llig</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="overdueTasks">-</div>
                    <div class="stat-label">√úberf√§llig</div>
                </div>
            </div>
            
            <!-- Task Content -->
            <div id="smartTasks">
                <div class="loading">Lade Tasks...</div>
            </div>
        </div>
        
        <!-- Mistral Interface - Right Side -->
        <div class="mistral-sidebar">
            <div class="mistral-header">
                <h2>ü§ñ Mistral AI Assistant</h2>
                <p>Intelligente Unterst√ºtzung f√ºr Ihre Tasks</p>
            </div>
            
            <div class="mistral-chat">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>‚ö° Schnellaktionen</h3>
                    <div class="quick-actions-grid">
                        <button class="quick-action-btn" onclick="askMistral('Priorisiere meine heutigen Tasks')">Priorisieren</button>
                        <button class="quick-action-btn" onclick="askMistral('Zeige mir √ºberf√§llige Tasks')">√úberf√§llig</button>
                        <button class="quick-action-btn" onclick="askMistral('Erstelle einen Tagesplan')">Tagesplan</button>
                        <button class="quick-action-btn" onclick="askMistral('Analysiere meine Task-Verteilung')">Analyse</button>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-text">Hallo! Ich bin Ihr AI-Assistent f√ºr Task-Management. Wie kann ich Ihnen heute helfen?</div>
                        <div class="message-time">Jetzt</div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-container">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Fragen Sie Mistral nach Hilfe bei Ihren Tasks..."
                        rows="2"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">Senden</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allTasks = [];
        let filteredTasks = [];
        let currentFilter = 'all';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            setupEventListeners();
            updateCurrentDate();
        });
        
        // Update current date display
        function updateCurrentDate() {
            const currentDateElement = document.getElementById('currentDate');
            if (currentDateElement) {
                const today = dateSync.getCurrentDate();
                const dayName = dateSync.formatDayOfWeek(today.getDay());
                const dayNumber = today.getDate();
                const monthName = dateSync.formatMonth(today.getMonth());
                const year = today.getFullYear();
                
                currentDateElement.textContent = `${dayName}, ${dayNumber}. ${monthName} ${year}`;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        // Load tasks from API
        async function loadTasks() {
            try {
                const response = await fetch('/api/smart-tasks');
                const data = await response.json();
                allTasks = data.tasks || [];
                filteredTasks = [...allTasks];
                renderTasks();
                updateStats();
            } catch (error) {
                console.error('Fehler beim Laden der Tasks:', error);
                document.getElementById('smartTasks').innerHTML = '<div class="loading">Fehler beim Laden der Tasks</div>';
            }
        }

        // Filter tasks
        function filterTasks(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch (filter) {
                case 'all':
                    filteredTasks = [...allTasks];
                    renderMarkdownStructure();
                    break;
                case 'heute':
                    filteredTasks = getTodayTasks();
                    renderTodayView();
                    break;
                case 'woche':
                    filteredTasks = getWeekTasks();
                    renderMarkdownStructure();
                    break;
                case 'hoch':
                    filteredTasks = allTasks.filter(task => task.priority === 'high');
                    renderTasks();
                    break;
                case '√ºberf√§llig':
                    filteredTasks = allTasks.filter(task => task.deadline_status === 'overdue');
                    renderTasks();
                    break;
            }
            
            updateStats();
        }

        // Get today's tasks
        function getTodayTasks() {
            const today = dateSync.formatDateForAPI(dateSync.getCurrentDate());
            return allTasks.filter(task => {
                if (!task.due_date) return false;
                return task.due_date === today || 
                       task.priority === 'high' || 
                       task.deadline_status === 'overdue' ||
                       task.tags.includes('urgent');
            });
        }

        // Get week's tasks
        function getWeekTasks() {
            const currentWeekStart = dateSync.getCurrentWeekStart();
            const nextWeekStart = dateSync.getNextWeekStart();
            
            return allTasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date);
                return taskDate >= currentWeekStart && taskDate < nextWeekStart;
            });
        }

        // Render Smart Task Structure View (Dynamic)
        function renderMarkdownStructure() {
            const container = document.getElementById('smartTasks');
            
            // Get current week and next week using DateSync
            const currentWeekStart = dateSync.getCurrentWeekStart();
            const nextWeekStart = dateSync.getNextWeekStart();
            
            // Group tasks by due dates and categories
            const thisWeekTasks = filteredTasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date);
                return taskDate >= currentWeekStart && taskDate < nextWeekStart;
            });
            
            const nextWeekTasks = filteredTasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date);
                const nextWeekEnd = new Date(nextWeekStart);
                nextWeekEnd.setDate(nextWeekStart.getDate() + 7);
                return taskDate >= nextWeekStart && taskDate < nextWeekEnd;
            });
            
            const overdueTasks = filteredTasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date);
                return taskDate < currentWeekStart;
            });
            
            const noDateTasks = filteredTasks.filter(task => !task.due_date);
            
            // Get later tasks (beyond next week)
            const laterTasks = filteredTasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date);
                const nextWeekEnd = new Date(nextWeekStart);
                nextWeekEnd.setDate(nextWeekStart.getDate() + 7);
                return taskDate >= nextWeekEnd;
            });
            
            // Group later tasks by month
            const tasksByMonth = {};
            laterTasks.forEach(task => {
                const taskDate = new Date(task.due_date);
                const monthKey = `${taskDate.getFullYear()}-${String(taskDate.getMonth() + 1).padStart(2, '0')}`;
                const monthName = dateSync.formatMonth(taskDate.getMonth());
                const year = taskDate.getFullYear();
                const displayKey = `${monthName} ${year}`;
                
                if (!tasksByMonth[displayKey]) {
                    tasksByMonth[displayKey] = [];
                }
                tasksByMonth[displayKey].push(task);
            });
            
            // Get week days from DateSync
            const weekDays = dateSync.getWeekDays();
            
            container.innerHTML = `
                <div class="smart-structure-view">
                    <div style="background: var(--primary-light); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-6); border: 1px solid var(--primary);">
                        <h3 style="color: var(--primary); margin: 0 0 var(--space-2) 0;">üìÖ Aktuelles Datum</h3>
                        <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                            Heute ist ${dateSync.formatDayOfWeek(dateSync.getCurrentDayOfWeek())}, ${dateSync.getCurrentDate().getDate()}. ${dateSync.formatMonth(dateSync.getCurrentDate().getMonth())} ${dateSync.getCurrentDate().getFullYear()}
                        </p>
                    </div>
                    
                    ${overdueTasks.length > 0 ? `
                        <h2 style="color: var(--highlight); font-size: 20px; font-weight: 500; margin: var(--space-6) 0 var(--space-3) 0;">‚ö†Ô∏è √úberf√§llige Tasks</h2>
                        ${renderTaskGroup(overdueTasks)}
                    ` : ''}
                    
                    <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 500; margin: var(--space-6) 0 var(--space-3) 0;">üìÖ Diese Woche (${dateSync.getCurrentWeekRange()})</h2>
                    
                    ${weekDays.map(day => {
                        const tasks = thisWeekTasks.filter(task => task.due_date === day.apiFormat);
                        if (tasks.length === 0) return '';
                        
                        return `
                            <h3 style="color: var(--text-primary); font-size: 16px; font-weight: 500; margin: var(--space-4) 0 var(--space-2) 0;">${day.dayName}, ${day.dayNumber}. ${day.monthName}</h3>
                            ${renderTaskGroup(tasks)}
                        `;
                    }).join('')}
                    
                    ${nextWeekTasks.length > 0 ? `
                        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 500; margin: var(--space-6) 0 var(--space-3) 0;">üìÖ N√§chste Woche (${dateSync.getNextWeekRange()})</h2>
                        ${renderTaskGroup(nextWeekTasks)}
                    ` : ''}
                    
                    ${Object.keys(tasksByMonth).length > 0 ? `
                        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 500; margin: var(--space-6) 0 var(--space-3) 0;">üìÖ Sp√§tere Termine</h2>
                        ${Object.keys(tasksByMonth).sort().map(month => `
                            <h3 style="color: var(--text-primary); font-size: 16px; font-weight: 500; margin: var(--space-4) 0 var(--space-2) 0;">üìÖ ${month}</h3>
                            ${renderTaskGroup(tasksByMonth[month])}
                        `).join('')}
                    ` : ''}
                    
                    ${noDateTasks.length > 0 ? `
                        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 500; margin: var(--space-6) 0 var(--space-3) 0;">üìã Tasks ohne Datum</h2>
                        ${renderTaskGroup(noDateTasks)}
                    ` : ''}
                </div>
            `;
        }

        // Render today's view with priority sections
        function renderTodayView() {
            const container = document.getElementById('smartTasks');
            
            // Group tasks by priority
            const highPriorityTasks = filteredTasks.filter(task => task.priority === 'high' || task.deadline_status === 'overdue');
            const mediumPriorityTasks = filteredTasks.filter(task => task.priority === 'medium' && task.deadline_status !== 'overdue');
            const lowPriorityTasks = filteredTasks.filter(task => task.priority === 'low');
            
            container.innerHTML = `
                <div style="margin-bottom: var(--space-6);">
                    <h2 style="color: var(--primary); margin: 0;">üìÖ Heute - ${dateSync.formatDayOfWeek(dateSync.getCurrentDayOfWeek())}, ${dateSync.getCurrentDate().getDate()}. ${dateSync.formatMonth(dateSync.getCurrentDate().getMonth())}</h2>
                    <p style="color: var(--text-tertiary); margin: var(--space-2) 0 0 0;">${filteredTasks.length} Tasks f√ºr heute</p>
                </div>
                
                ${highPriorityTasks.length > 0 ? `
                    <div style="margin-bottom: var(--space-6);">
                        <h3 style="color: var(--highlight); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                            üî• HOCHPRIORIT√ÑT (${highPriorityTasks.length} Tasks)
                        </h3>
                        ${renderTaskGroup(highPriorityTasks)}
                    </div>
                ` : ''}
                
                ${mediumPriorityTasks.length > 0 ? `
                    <div style="margin-bottom: var(--space-6);">
                        <h3 style="color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                            ‚ö° MITTELPRIORIT√ÑT (${mediumPriorityTasks.length} Tasks)
                        </h3>
                        ${renderTaskGroup(mediumPriorityTasks)}
                    </div>
                ` : ''}
                
                ${lowPriorityTasks.length > 0 ? `
                    <div style="margin-bottom: var(--space-6);">
                        <h3 style="color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                            üìù NIEDRIGPRIORIT√ÑT (${lowPriorityTasks.length} Tasks)
                        </h3>
                        ${renderTaskGroup(lowPriorityTasks)}
                    </div>
                ` : ''}
                
                <div style="background: var(--primary-light); border-radius: var(--radius-lg); padding: var(--space-4); margin-top: var(--space-6); border: 1px solid var(--primary);">
                    <h4 style="color: var(--primary); margin: 0 0 var(--space-2) 0;">üí° Heute-Fokus</h4>
                    <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                        Konzentrieren Sie sich zuerst auf die <strong>Hochpriorit√§t</strong> Tasks. 
                        ${highPriorityTasks.length > 0 ? `Sie haben ${highPriorityTasks.length} √ºberf√§llige oder hochpriorit√§re Tasks.` : 'Alle Hochpriorit√§t-Tasks sind erledigt!'}
                    </p>
                </div>
            `;
        }

        // Render a group of tasks
        function renderTaskGroup(tasks) {
            return tasks.map(task => {
                const hierarchyClass = task.hierarchy_level ? `hierarchy-level-${task.hierarchy_level}` : '';
                
                // Remove markdown formatting (**) from task titles
                const cleanTitle = task.title.replace(/\*\*/g, '').trim();
                
                return `
                    <div class="smart-task-card ${task.priority}-priority ${task.deadline_status.replace('_', '-')} ${hierarchyClass}" onclick="toggleTask('${task.id}')">
                        <div class="task-content">
                            <div class="task-title">${cleanTitle}</div>
                        </div>
                        <div class="task-meta">
                            <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                            ${task.deadline_status !== 'no_deadline' ? `<span class="deadline-badge deadline-${task.deadline_status.replace('_', '-')}">${getDeadlineText(task.deadline_status)}</span>` : ''}
                        </div>
                        ${task.due_date ? `
                            <div class="due-date-display">
                                üìÖ ${dateSync.formatDateForDisplay(new Date(task.due_date))}
                                ${(() => {
                                    const dueDate = new Date(task.due_date);
                                    const today = dateSync.getCurrentDate();
                                    const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                                    
                                    if (diffDays === 0) return '<span style="color: var(--highlight); font-weight: 600;">(Heute)</span>';
                                    if (diffDays === 1) return '<span style="color: var(--primary); font-weight: 500;">(Morgen)</span>';
                                    if (diffDays === -1) return '<span style="color: var(--highlight); font-weight: 600;">(Gestern)</span>';
                                    if (diffDays < 0) return `<span style="color: var(--highlight); font-weight: 600;">(vor ${Math.abs(diffDays)} Tagen)</span>`;
                                    return `<span style="color: var(--text-secondary);">(in ${diffDays} Tagen)</span>`;
                                })()}
                            </div>
                        ` : ''}
                        <div class="task-stats">
                            <span>‚è±Ô∏è ${task.estimated_duration_minutes}min</span>
                            <span>üìÅ ${task.category}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render tasks (fallback)
        function renderTasks() {
            const container = document.getElementById('smartTasks');
            container.innerHTML = renderTaskGroup(filteredTasks);
        }

        // Update statistics
        function updateStats() {
            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(task => task.status === 'completed').length;
            const dueToday = getTodayTasks().length;
            const overdueTasks = allTasks.filter(task => task.deadline_status === 'overdue').length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('dueToday').textContent = dueToday;
            document.getElementById('overdueTasks').textContent = overdueTasks;
        }

        // Get deadline text
        function getDeadlineText(status) {
            const statusMap = {
                'overdue': '√úberf√§llig',
                'due_today': 'Heute',
                'due_tomorrow': 'Morgen',
                'due_soon': 'Bald',
                'due_this_week': 'Diese Woche',
                'due_later': 'Sp√§ter',
                'no_deadline': 'Kein Datum'
            };
            return statusMap[status] || status;
        }

        // Toggle task completion
        function toggleTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'completed' ? 'pending' : 'completed';
                task.updated_at = new Date().toISOString();
                
                // Update display
                renderTasks();
                updateStats();
                
                // TODO: Send update to API
                console.log(`Task ${taskId} toggled to ${task.status}`);
            }
        }

        // Mistral AI Functions
        async function askMistral(prompt) {
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // Add user message
            addMessage('user', prompt);
            
            // Clear input and disable send button
            chatInput.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sende...';
            
            try {
                const response = await fetch('/api/mistral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addMessage('assistant', data.response);
                } else {
                    addMessage('assistant', `Fehler: ${data.error}`);
                }
            } catch (error) {
                console.error('Mistral API Fehler:', error);
                addMessage('assistant', 'Entschuldigung, es gab einen Fehler beim Verbinden mit Mistral.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Senden';
            }
        }

        // Send message
        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message) {
                askMistral(message);
            }
        }

        // Add message to chat
        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-text">${text}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>