<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Task Dashboard - DaisyUI</title>
    
    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Local Scripts -->
    <script src="ui-guidelines.js"></script>
    <script src="date-sync.js"></script>
    
    <!-- Modulare Architektur -->
    <script src="js/services/ApiService.js"></script>
    <script src="js/modules/APIManager.js"></script>
    <script src="js/modules/TaskService.js"></script>
    <script src="js/modules/HybridMigration.js"></script>
</head>
<body class="bg-base-100 min-h-screen">
    <div class="w-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-0">
            <!-- Smart Task Dashboard - Left Side -->
            <div class="lg:col-span-2">
                <div class="p-6">
                    <!-- Header -->
                    <div class="navbar bg-base-100 shadow-sm mb-4">
                        <div class="navbar-start">
                            <h1 id="currentDateLarge" class="text-2xl font-bold text-primary">Lade Datum...</h1>
                        </div>
                        <div class="navbar-end">
                            <div class="flex items-center gap-2">
                                <!-- Theme Toggle -->
                                <button class="btn btn-ghost btn-sm" onclick="toggleTheme()" title="Theme wechseln">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-primary" onclick="openTaskCreationModal()" title="Neuen Task erstellen">
                                    ‚ûï Neuer Task
                                </button>
                                <button class="btn btn-secondary" onclick="openCategoryManagementModal()" title="Kategorien verwalten">
                                    üìÅ Kategorien
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="form-control w-full max-w-md mb-4">
                        <div class="join w-full">
                            <input type="text" id="searchInput" class="input input-bordered join-item flex-1" placeholder="üîç Nach Tasks suchen..." onkeyup="searchTasks()">
                            <button class="btn btn-square btn-outline join-item" onclick="clearSearch()" title="Suche l√∂schen">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter & Sortierung Bar -->
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <div class="flex flex-wrap gap-2">
                            <button class="btn btn-sm active" onclick="filterTasks('heute')">Heute</button>
                            <button class="btn btn-sm" onclick="filterTasks('woche')">Diese Woche</button>
                            <button class="btn btn-sm" onclick="filterTasks('all')">Alle</button>
                            
                            <!-- Category Filter Dropdown -->
                            <div class="dropdown">
                                <div tabindex="0" role="button" class="btn btn-sm">
                                    üìÅ Alle Kategorien
                                </div>
                                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                                    <li><a onclick="filterTasksWithData('category', '')">üìÅ Alle Kategorien</a></li>
                                </ul>
                            </div>
                            
                            <!-- Priority Filter Dropdown -->
                            <div class="dropdown">
                                <div tabindex="0" role="button" class="btn btn-sm">
                                    ‚ö° Alle Priorit√§ten
                                </div>
                                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                                    <li><a onclick="filterTasksWithData('priority', '')">‚ö° Alle Priorit√§ten</a></li>
                                    <li><a onclick="filterTasksWithData('priority', 'high')">üî¥ Hoch</a></li>
                                    <li><a onclick="filterTasksWithData('priority', 'medium')">üü° Mittel</a></li>
                                    <li><a onclick="filterTasksWithData('priority', 'low')">üü¢ Niedrig</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <button class="btn btn-sm active" onclick="setSorting('priority')">Nach Priorit√§t</button>
                            <button class="btn btn-sm" onclick="setSorting('category')">Nach Kategorie</button>
                            <label class="label cursor-pointer">
                                <span class="label-text">Erledigte einblenden</span>
                                <input type="checkbox" id="hideCompletedToggle" class="toggle toggle-primary" checked onchange="toggleCompletedTasks()">
                            </label>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Bar -->
                    <div id="bulkActions" class="alert alert-info shadow-lg mb-4" style="display: none;">
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-4">
                                <span id="selectedCount" class="font-semibold">0</span> Tasks ausgew√§hlt
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-outline" onclick="selectAllTasks()">Alle ausw√§hlen</button>
                                    <button class="btn btn-sm btn-outline" onclick="deselectAllTasks()">Auswahl aufheben</button>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <!-- Bulk Category Change -->
                                <div class="dropdown dropdown-end">
                                    <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                                        üìÅ Kategorie √§ndern
                                    </div>
                                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                                        <li><a onclick="bulkChangeCategory('')">üìÅ Alle Kategorien</a></li>
                                    </ul>
                                </div>
                                
                                <!-- Bulk Priority Change -->
                                <div class="dropdown dropdown-end">
                                    <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                                        ‚ö° Priorit√§t √§ndern
                                    </div>
                                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                                        <li><a onclick="bulkChangePriority('high')">üî¥ Hoch</a></li>
                                        <li><a onclick="bulkChangePriority('medium')">üü° Mittel</a></li>
                                        <li><a onclick="bulkChangePriority('low')">üü¢ Niedrig</a></li>
                                    </ul>
                                </div>
                                
                                <button class="btn btn-sm btn-outline" onclick="openBulkDatePicker()">üìÖ Datum setzen</button>
                                <button class="btn btn-sm btn-outline" onclick="bulkRemoveDueDate()">üóìÔ∏è Datum entfernen</button>
                                <button class="btn btn-sm btn-error" onclick="bulkDeleteTasks()">üóëÔ∏è L√∂schen</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Task Content -->
                    <div id="smartTasks" class="mt-6">
                        <div class="text-center text-base-content/60">Lade Tasks...</div>
                    </div>
                </div>
            </div>
            
            <!-- Mistral Interface - Right Side -->
            <div class="lg:col-span-1">
                <div class="p-6 border-l border-base-300">
                    <div class="flex items-center gap-2 mb-4">
                        <h2 class="text-xl font-bold text-primary">ü§ñ Mistral AI Assistant</h2>
                        <p class="text-sm text-base-content/70">Intelligente Unterst√ºtzung f√ºr Ihre Tasks</p>
                    </div>
                    
                    <div class="bg-base-200 rounded-lg p-4 mb-4" style="height: 400px; overflow-y: auto;">
                        <!-- Chat Messages -->
                        <div id="chatMessages">
                            <div class="chat chat-start">
                                <div class="chat-bubble chat-bubble-primary">
                                    <div class="message-text">Hallo! Ich bin Ihr AI-Assistent f√ºr Task-Management. Wie kann ich Ihnen heute helfen?</div>
                                    <div class="message-time text-xs opacity-70">Jetzt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="flex gap-2">
                        <textarea 
                            class="textarea textarea-bordered flex-1 resize-none" 
                            id="chatInput" 
                            placeholder="Fragen Sie Mistral nach Hilfe bei Ihren Tasks..."
                            rows="2"
                        ></textarea>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">Senden</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <dialog id="taskCreationModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">üìù Neuen Task erstellen</h3>
            <form id="taskForm">
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">Titel:</span>
                    </label>
                    <input type="text" id="taskTitle" name="title" class="input input-bordered w-full" placeholder="Task-Titel eingeben..." required>
                </div>
                
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">Kategorie:</span>
                    </label>
                    <select id="taskCategory" name="category" class="select select-bordered w-full">
                        <option value="General">General</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Development">Development</option>
                        <option value="Business">Business</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>
                
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">Priorit√§t:</span>
                    </label>
                    <select id="taskPriority" name="priority" class="select select-bordered w-full">
                        <option value="low">üü¢ Niedrig</option>
                        <option value="medium" selected>üü° Mittel</option>
                        <option value="high">üî¥ Hoch</option>
                    </select>
                </div>
                
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">F√§lligkeitsdatum:</span>
                    </label>
                    <input type="text" id="taskDueDate" name="dueDate" class="input input-bordered w-full" placeholder="Datum ausw√§hlen..." readonly>
                </div>
            </form>
            <div class="modal-action">
                <button type="button" class="btn btn-outline" onclick="closeTaskCreationModal()">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="submitTaskForm()">Task erstellen</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    
    <!-- Category Management Modal -->
    <dialog id="categoryManagementModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">üìÅ Kategorien verwalten</h3>
            <div class="mb-6">
                <div class="space-y-2" id="categoryList">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Neue Kategorie:</span>
                </label>
                <div class="join w-full">
                    <input type="text" id="newCategoryName" class="input input-bordered join-item flex-1" placeholder="Kategorie-Name eingeben">
                    <button class="btn btn-primary join-item" onclick="createCategory()">Erstellen</button>
                </div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-outline" onclick="closeCategoryManagementModal()">Schlie√üen</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        // Hier kommt der komplette JavaScript-Code aus der urspr√ºnglichen index.html
        // Aber mit DaisyUI-optimierten Komponenten
        
        // Global variables
        let allTasks = [];
        let filteredTasks = [];
        let currentFilter = 'heute';
        let currentSorting = 'priority';
        let searchQuery = '';
        let hideCompleted = true;
        let selectedTasks = new Set();
        let draggedTaskId = null;

        // Theme Toggle Funktion
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Theme beim Laden setzen
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // DaisyUI-optimierte Task-Rendering-Funktion
        function renderSingleTask(task) {
            const hierarchyClass = task.hierarchy_level ? `hierarchy-level-${task.hierarchy_level}` : '';
            const completedClass = task.status === 'completed' ? 'completed-task' : '';
            
            // Remove markdown formatting (**) and category symbols from task titles
            const cleanTitle = task.title.replace(/\*\*/g, '').replace(/\s*üìÅ\s*[^-\s]+/g, '').trim();
            
            // Bei Kategorie-Sortierung: Priorit√§t-Badge nur anzeigen wenn nicht "medium"
            const showPriorityBadge = currentSorting === 'priority' || task.priority !== 'medium';
            
            // Zeige Priorit√§t-Button nur wenn Priorit√§t nicht sichtbar ist
            const showPriorityButton = !showPriorityBadge && task.status !== 'completed';
            
            return `
                <div class="flex items-center gap-3 py-2 px-3 hover:bg-base-200 rounded transition-colors ${task.priority}-priority ${task.deadline_status && task.deadline_status !== null ? task.deadline_status.replace('_', '-') : 'no-deadline'} ${hierarchyClass} ${completedClass}" 
                     draggable="true" 
                     ondragstart="dragStart(event, '${task.id}')" 
                     ondragend="dragEnd(event)"
                     data-task-id="${task.id}"
                     ondragover="dragOver(event)"
                     ondragenter="dragEnter(event)"
                     ondragleave="dragLeave(event)"
                     ondrop="drop(event)">
                    <input type="checkbox" class="checkbox checkbox-sm" data-task-id="${task.id}" onchange="toggleTaskSelection('${task.id}')">
                    <span class="text-lg cursor-pointer hover:scale-110 transition-transform" onclick="event.stopPropagation(); toggleTask('${task.id}')">
                        ${task.status === 'completed' ? '‚úÖ' : '‚òê'}
                    </span>
                    <div class="flex-1 min-w-0">
                        <div class="task-title-editable cursor-pointer hover:bg-base-300 rounded px-1 py-0.5 transition-colors" onclick="event.stopPropagation(); startEditTitle('${task.id}', '${cleanTitle.replace(/'/g, "\\'")}')">
                            <span class="text-sm font-normal truncate">${cleanTitle}</span>
                            <span class="text-xs opacity-0 group-hover:opacity-100 transition-opacity ml-1">‚úèÔ∏è</span>
                        </div>
                        <input type="text" class="input input-sm w-full" style="display: none;" onblur="saveEditTitle('${task.id}')" onkeypress="handleEditKeypress(event, '${task.id}')" />
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${showPriorityBadge ? `
                            <div class="badge badge-outline badge-sm cursor-pointer hover:badge-primary transition-colors" onclick="event.stopPropagation(); showPriorityMenu('${task.id}', '${task.priority}', event)">
                                ${task.priority === 'high' ? 'üî¥ Hoch' : task.priority === 'medium' ? 'üü° Mittel' : 'üü¢ Niedrig'}
                            </div>
                        ` : ''}
                        
                        ${showPriorityButton ? `
                            <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); showPriorityMenu('${task.id}', '${task.priority}', event)" title="Priorit√§t hinzuf√ºgen">
                                ‚ö°
                            </button>
                        ` : ''}
                        ${task.deadline_status && task.deadline_status !== null && task.deadline_status !== 'no_deadline' && task.deadline_status !== 'due_today' ? `<span class="badge badge-secondary badge-sm">${getDeadlineText(task.deadline_status)}</span>` : ''}
                        <button class="btn btn-ghost btn-xs text-error hover:bg-error hover:text-error-content" onclick="event.stopPropagation(); deleteTask('${task.id}')" title="Task l√∂schen">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        // Modal Management Functions
        function openTaskCreationModal() {
            document.getElementById('taskCreationModal').showModal();
            document.getElementById('taskTitle').focus();
        }

        function closeTaskCreationModal() {
            document.getElementById('taskCreationModal').close();
            document.getElementById('taskForm').reset();
        }

        function openCategoryManagementModal() {
            document.getElementById('categoryManagementModal').showModal();
            loadCategories();
        }

        function closeCategoryManagementModal() {
            document.getElementById('categoryManagementModal').close();
        }

        // Initialize theme on page load
        initializeTheme();

        // Placeholder functions - diese m√ºssen aus der urspr√ºnglichen index.html kopiert werden
        function filterTasks(filter) {
            console.log('Filter tasks:', filter);
        }

        function filterTasksWithData(filter, dataValue) {
            console.log('Filter tasks with data:', filter, dataValue);
        }

        function setSorting(sorting) {
            console.log('Set sorting:', sorting);
        }

        function toggleCompletedTasks() {
            console.log('Toggle completed tasks');
        }

        function searchTasks() {
            console.log('Search tasks');
        }

        function clearSearch() {
            console.log('Clear search');
        }

        function selectAllTasks() {
            console.log('Select all tasks');
        }

        function deselectAllTasks() {
            console.log('Deselect all tasks');
        }

        function bulkChangeCategory(category) {
            console.log('Bulk change category:', category);
        }

        function bulkChangePriority(priority) {
            console.log('Bulk change priority:', priority);
        }

        function openBulkDatePicker() {
            console.log('Open bulk date picker');
        }

        function bulkRemoveDueDate() {
            console.log('Bulk remove due date');
        }

        function bulkDeleteTasks() {
            console.log('Bulk delete tasks');
        }

        function submitTaskForm() {
            console.log('Submit task form');
        }

        function createCategory() {
            console.log('Create category');
        }

        function loadCategories() {
            console.log('Load categories');
        }

        function sendMessage() {
            console.log('Send message');
        }

        function toggleTask(taskId) {
            console.log('Toggle task:', taskId);
        }

        function toggleTaskSelection(taskId) {
            console.log('Toggle task selection:', taskId);
        }

        function startEditTitle(taskId, title) {
            console.log('Start edit title:', taskId, title);
        }

        function saveEditTitle(taskId) {
            console.log('Save edit title:', taskId);
        }

        function handleEditKeypress(event, taskId) {
            console.log('Handle edit keypress:', event, taskId);
        }

        function showPriorityMenu(taskId, priority, event) {
            console.log('Show priority menu:', taskId, priority, event);
        }

        function showCategoryMenu(taskId, category, event) {
            console.log('Show category menu:', taskId, category, event);
        }

        function deleteTask(taskId) {
            console.log('Delete task:', taskId);
        }

        function dragStart(event, taskId) {
            console.log('Drag start:', taskId);
        }

        function dragEnd(event) {
            console.log('Drag end');
        }

        function dragOver(event) {
            console.log('Drag over');
        }

        function dragEnter(event) {
            console.log('Drag enter');
        }

        function dragLeave(event) {
            console.log('Drag leave');
        }

        function drop(event) {
            console.log('Drop');
        }

        function getDeadlineText(deadlineStatus) {
            return deadlineStatus;
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DaisyUI Todo App initialized');
            
            // Initialize theme
            initializeTheme();
            
            // Initialize Hybrid Migration after existing initialization
            setTimeout(async () => {
                try {
                    window.hybridMigration = new HybridMigration();
                    await window.hybridMigration.initialize();
                    console.log('üéâ Hybrid Migration erfolgreich aktiviert!');
                } catch (error) {
                    console.error('‚ùå Hybrid Migration Fehler:', error);
                }
            }, 1000);
        });
    </script>
</body>
</html>
